name: Connect to Docker via Tailscale

on:
  push:
    branches:
      - main

jobs:
  ssh-container:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Install Tailscale
      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscaled &
          sleep 5
          sudo tailscale up --authkey ${{ secrets.TAILSCALE_AUTHKEY }}

      # Step 2: Wait for Tailscale to be ready
      - name: Wait for Tailscale
        run: sleep 10

      # Step 3: SSH into Docker container and deploy Go app
      - name: SSH into Docker container via SSH key
        run: |
          mkdir -p ~/.ssh
          printf "%s\n" "${{ secrets.GH_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_ed25519 root@100.125.140.68 -p 2222 << 'EOF'
            echo "Connected to Docker container via Tailscale!"

            # Kill previous Go app if running
            if pgrep -f './app' > /dev/null; then
              echo "Stopping previous app..."
              pkill -f './app'
            fi

            # Ensure project directory exists
            if [ ! -d ~/ginserver ]; then
              git clone https://github.com/wrongonex/ginserver.git ~/ginserver
            fi

            cd ~/ginserver
            git reset --hard
            git pull

            # Download Go modules
            go mod download

            # Build Go app
            go build -o app

            # Start the app in background and log output
            nohup ./app > ~/app.log 2>&1 &
            echo "App restarted successfully!"

            # Optional: List files to verify
            ls -l ~
          EOF
