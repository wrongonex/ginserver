name: Connect to Docker via Tailscale

on:
  push:
    branches:
      - main

jobs:
  ssh-container:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Install Tailscale
      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscaled &
          sleep 5
          sudo tailscale up --authkey ${{ secrets.TAILSCALE_AUTHKEY }}

      # Step 2: Wait for Tailscale to be ready
      - name: Wait for Tailscale
        run: sleep 10

      # Step 3: SSH into Docker container and run commands
      - name: SSH into Docker container via SSH key
        run: |
          mkdir -p ~/.ssh
          printf "%s\n" "${{ secrets.GH_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_ed25519 root@100.125.140.68 -p 2222 "bash -lc '
            set -e

            echo \"Connected to Docker container via Tailscale!\"
            date

            which go
            go version

            echo \"IM all good baby\" > ~/hello.txt
            cat ~/hello.txt

            if [ ! -d ~/ginserver ]; then
              git clone https://github.com/wrongonex/ginserver.git ~/ginserver
            else
              cd ~/ginserver
              git reset --hard
              git pull
            fi

            cd ~/ginserver

            go mod download
            go build -o app

            pkill app || true
            nohup ./app > ~/app.log 2>&1 &

            ls -l ~
          '"
